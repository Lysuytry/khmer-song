{"version":3,"sources":["../../../src/api/playlist/playlist.api.js"],"names":["getPlaylist","req","res","userId","body","limit","offset","name","query","fliterName","Op","like","conditions","rows","count","Playlist","findAndCountAll","where","success","error","fail","createPlaylist","user","User","findById","playlist","findOrCreate","defaults","deletePlaylist","transaction","sequelize","id","params","Promise","all","destroy","PlaylistSong","playlistId","commit","rollback","message","getSongFromPlaylist","songs","removeSongFromPlaylist","songId","findOne","attributes","row","addSongToPlaylist","status","song","Song","isNewRecord","raw"],"mappings":";;;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEO,MAAMA,oCAAc,OAAOC,GAAP,EAAYC,GAAZ,KAAoB;AAC7C,MAAI;AACF,UAAM,EAAEC,MAAF,KAAaF,IAAIG,IAAvB;AACA,UAAM,EAAEC,KAAF,EAASC,MAAT,EAAiBC,IAAjB,KAA0BN,IAAIO,KAApC;AACA,UAAMC,aAAaF,OAAO,EAAEA,MAAM,EAAE,CAACG,wBAAGC,IAAJ,GAAY,IAAGJ,IAAK,GAAtB,EAAR,EAAP,GAA8C,EAAjE;AACA,UAAMK,wBAAeT,MAAf,IAA0BM,UAA1B,CAAN;AACA,UAAM,EAAEI,IAAF,EAAQC,KAAR,KAAkB,MAAMC,mBAASC,eAAT,CAAyB,EAAEC,OAAOL,UAAT,EAAqBN,MAArB,EAA6BD,KAA7B,EAAzB,CAA9B;AACAH,QAAIgB,OAAJ,CAAYL,IAAZ,EAAkB,EAAEC,KAAF,EAAST,KAAT,EAAgBC,MAAhB,EAAlB;AACD,GAPD,CAOE,OAAOa,KAAP,EAAc;AACdjB,QAAIkB,IAAJ,CAASD,KAAT;AACD;AACF,CAXM;;AAaA,MAAME,0CAAiB,OAAOpB,GAAP,EAAYC,GAAZ,KAAoB;AAChD,MAAI;AACF,UAAM,EAAEK,IAAF,EAAQJ,MAAR,KAAmBF,IAAIG,IAA7B;AACA;AACA,UAAMkB,OAAO,MAAMC,eAAKC,QAAL,CAAcrB,MAAd,CAAnB;AACA,UAAM,CAACsB,QAAD,IAAa,CAACH,IAAD,GACfpB,IAAIkB,IAAJ,CAAS,uBAAT,CADe,GAEf,MAAML,mBAASW,YAAT,CAAsB,EAAET,OAAO,EAAEV,IAAF,EAAQJ,MAAR,EAAT,EAA2BwB,UAAU1B,IAAIG,IAAzC,EAAtB,CAFV;AAGAF,QAAIgB,OAAJ,CAAYO,QAAZ;AACD,GARD,CAQE,OAAON,KAAP,EAAc;AACdjB,QAAIkB,IAAJ,CAASD,KAAT;AACD;AACF,CAZM;;AAcA,MAAMS,0CAAiB,OAAO3B,GAAP,EAAYC,GAAZ,KAAoB;AAChD,QAAM2B,cAAc,MAAMC,+BAAUD,WAAV,EAA1B;AACA,MAAI;AACF,UAAM,EAAEE,EAAF,KAAS9B,IAAI+B,MAAnB;AACA,UAAM,EAAE7B,MAAF,KAAaF,IAAIG,IAAvB;AACA,UAAM6B,QAAQC,GAAR,CAAY,CAChBnB,mBAASoB,OAAT,CAAiB,EAAElB,OAAO,EAAEc,EAAF,EAAM5B,MAAN,EAAT,EAAyB0B,WAAzB,EAAjB,CADgB,EAEhBO,uBAAaD,OAAb,CAAqB,EAAElB,OAAO,EAAEoB,YAAYN,EAAd,EAAT,EAA6BF,WAA7B,EAArB,CAFgB,CAAZ,CAAN;AAIAA,gBAAYS,MAAZ;AACApC,QAAIgB,OAAJ,CAAY,uBAAZ;AACD,GATD,CASE,OAAOC,KAAP,EAAc;AACdU,gBAAYU,QAAZ;AACArC,QAAIkB,IAAJ,CAASD,MAAMqB,OAAf;AACD;AACF,CAfM;;AAiBA,MAAMC,oDAAsB,OAAOxC,GAAP,EAAYC,GAAZ,KAAoB;AACrD,MAAI;AACF,UAAM,EAAE6B,EAAF,KAAS9B,IAAI+B,MAAnB;AACA,UAAM,EAAE7B,MAAF,KAAaF,IAAIG,IAAvB;AACA,UAAM,EAAEC,KAAF,EAASC,MAAT,KAAoBL,IAAIO,KAA9B;AACA,UAAM,EAACkC,KAAD,EAAO5B,KAAP,KAAgB,MAAM,mCAAoB,EAACiB,EAAD,EAAK5B,MAAL,EAAaE,KAAb,EAAoBC,MAApB,EAApB,CAA5B;AACAJ,QAAIgB,OAAJ,CAAYwB,KAAZ,EAAmB,EAAC5B,KAAD,EAAQT,KAAR,EAAeC,MAAf,EAAnB;AACD,GAND,CAME,OAAOa,KAAP,EAAc;AACdjB,QAAIkB,IAAJ,CAASD,MAAMqB,OAAf;AACD;AACF,CAVM;;AAYA,MAAMG,0DAAyB,OAAO1C,GAAP,EAAYC,GAAZ,KAAoB;AACxD,MAAI;AACF,UAAM,EAAE6B,EAAF,EAAMa,MAAN,KAAiB3C,IAAI+B,MAA3B;AACA,UAAM,EAAE7B,MAAF,KAAaF,IAAIG,IAAvB;AACA;AACA;AACA,UAAMqB,WAAW,MAAMV,mBAAS8B,OAAT,CAAiB,EAAEC,YAAY,CAAC,IAAD,CAAd,EAAsB7B,OAAO,EAAEd,MAAF,EAAU4B,EAAV,EAA7B,EAAjB,CAAvB;AACA;AACA,QAAI,CAACN,QAAL,EAAevB,IAAIkB,IAAJ,CAAS,2BAAT;AACf;AACA,UAAM2B,MAAM,MAAMX,uBAAaD,OAAb,CAAqB,EAAElB,OAAO,EAAEoB,YAAYN,EAAd,EAAkBa,QAAQA,MAA1B,EAAT,EAArB,CAAlB;AACA;AACA,QAAI,CAACG,GAAL,EAAU,OAAO7C,IAAIkB,IAAJ,CAAS,qBAAT,CAAP;AACVlB,QAAIgB,OAAJ,CAAY,sBAAZ;AACD,GAbD,CAaE,OAAOC,KAAP,EAAc;AACdjB,QAAIkB,IAAJ,CAASD,MAAMqB,OAAf;AACD;AACF,CAjBM;;AAmBA,MAAMQ,gDAAoB,OAAO/C,GAAP,EAAYC,GAAZ,KAAoB;AACnD,MAAI;AACF,UAAM,EAAE+C,MAAF,KAAahD,IAAIO,KAAvB;AACA,UAAM,EAAEuB,EAAF,EAAMa,MAAN,KAAiB3C,IAAI+B,MAA3B;AACA,UAAM,EAAE7B,MAAF,KAAaF,IAAIG,IAAvB;AACA;AACA,UAAM,CAAC8C,IAAD,EAAOzB,QAAP,IAAmB,MAAMQ,QAAQC,GAAR,CAAY,CACzCiB,eAAKN,OAAL,CAAa,EAAEC,YAAY,CAAC,IAAD,CAAd,EAAsB7B,OAAO,EAAEc,IAAIa,MAAN,EAAcK,MAAd,EAA7B,EAAb,CADyC,EAEzClC,mBAAS8B,OAAT,CAAiB,EAAEC,YAAY,CAAC,IAAD,CAAd,EAAsB7B,OAAO,EAAEd,MAAF,EAAU4B,EAAV,EAA7B,EAAjB,CAFyC,CAAZ,CAA/B;AAIA;AACA,QAAI,CAACmB,IAAL,EAAW,OAAOhD,IAAIkB,IAAJ,CAAS,kBAAT,CAAP;AACX,QAAI,CAACK,QAAL,EAAe,OAAOvB,IAAIkB,IAAJ,CAAS,sBAAT,CAAP;AACf;AACA,UAAM,CAAC,EAAEgC,WAAF,EAAD,IAAoB,MAAMhB,uBAAaV,YAAb,CAA0B;AACxD2B,WAAK,IADmD;AAExDpC,aAAO,EAAEoB,YAAYN,EAAd,EAAkBa,MAAlB,EAFiD;AAGxDjB,gBAAU,EAAEU,YAAYN,EAAd,EAAkBa,MAAlB;AAH8C,KAA1B,CAAhC;AAKA;AACA,KAACQ,WAAD,GACIlD,IAAIgB,OAAJ,CAAY,qCAAZ,CADJ,GAEIhB,IAAIgB,OAAJ,CAAY,sCAAZ,CAFJ;AAGD,GAtBD,CAsBE,OAAOC,KAAP,EAAc;AACdjB,QAAIkB,IAAJ,CAASD,MAAMZ,IAAf;AACD;AACF,CA1BM","file":"playlist.api.js","sourcesContent":["import Playlist, {getSongByPlaylistId} from '../../models/playlist';\nimport User from '../../models/user';\nimport Song from '../../models/song';\nimport PlaylistSong from '../../models/playlist-song';\nimport { Op, sequelize } from '../../common/sequelize-connection';\n\nexport const getPlaylist = async (req, res) => {\n  try {\n    const { userId } = req.body;\n    const { limit, offset, name } = req.query;\n    const fliterName = name ? { name: { [Op.like]: `%${name}%` } } : {};\n    const conditions = { userId, ...fliterName };\n    const { rows, count } = await Playlist.findAndCountAll({ where: conditions, offset, limit });\n    res.success(rows, { count, limit, offset });\n  } catch (error) {\n    res.fail(error);\n  }\n};\n\nexport const createPlaylist = async (req, res) => {\n  try {\n    const { name, userId } = req.body;\n    //we must know who created it\n    const user = await User.findById(userId);\n    const [playlist] = !user\n      ? res.fail('User Id is not found.')\n      : await Playlist.findOrCreate({ where: { name, userId }, defaults: req.body });\n    res.success(playlist);\n  } catch (error) {\n    res.fail(error);\n  }\n};\n\nexport const deletePlaylist = async (req, res) => {\n  const transaction = await sequelize.transaction();\n  try {\n    const { id } = req.params;\n    const { userId } = req.body;\n    await Promise.all([\n      Playlist.destroy({ where: { id, userId }, transaction }),\n      PlaylistSong.destroy({ where: { playlistId: id }, transaction })\n    ]);\n    transaction.commit();\n    res.success('Successfully deleted.');\n  } catch (error) {\n    transaction.rollback();\n    res.fail(error.message);\n  }\n};\n\nexport const getSongFromPlaylist = async (req, res) => {\n  try {\n    const { id } = req.params;\n    const { userId } = req.body;\n    const { limit, offset } = req.query;\n    const {songs,count} = await getSongByPlaylistId({id, userId, limit, offset});\n    res.success(songs, {count, limit, offset});\n  } catch (error) {\n    res.fail(error.message);\n  }\n};\n\nexport const removeSongFromPlaylist = async (req, res) => {\n  try {\n    const { id, songId } = req.params;\n    const { userId } = req.body;\n    //check playlist Id is existing\n    //count >findOne\n    const playlist = await Playlist.findOne({ attributes: ['id'], where: { userId, id } });\n    //not => invalid playlist\n    if (!playlist) res.fail('Playlist Id is not valid.');\n    //success => check song id in playlistsong\n    const row = await PlaylistSong.destroy({ where: { playlistId: id, songId: songId } });\n    //if no check songId again\n    if (!row) return res.fail('Song Id is invalid.');\n    res.success('Successfully deletd.');\n  } catch (error) {\n    res.fail(error.message);\n  }\n};\n\nexport const addSongToPlaylist = async (req, res) => {\n  try {\n    const { status } = req.query;\n    const { id, songId } = req.params;\n    const { userId } = req.body;\n    //check if song if existing\n    const [song, playlist] = await Promise.all([\n      Song.findOne({ attributes: ['id'], where: { id: songId, status } }),\n      Playlist.findOne({ attributes: ['id'], where: { userId, id } })\n    ]);\n    //if not => return songId is not found\n    if (!song) return res.fail('Song is invalid.');\n    if (!playlist) return res.fail('Playlist is invalid.');\n    //existing => add to table playlistsong\n    const [{ isNewRecord }] = await PlaylistSong.findOrCreate({\n      raw: true,\n      where: { playlistId: id, songId },\n      defaults: { playlistId: id, songId }\n    });\n    //result._options.isNewRecord =\n    !isNewRecord\n      ? res.success('Song has already added to playlist.')\n      : res.success('Successfully added song to playlist.');\n  } catch (error) {\n    res.fail(error.name);\n  }\n};\n"]}