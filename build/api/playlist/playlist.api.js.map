{"version":3,"sources":["../../../src/api/playlist/playlist.api.js"],"names":["getPlaylist","req","res","id","params","limit","offset","name","query","fliterName","Op","like","conditions","userId","rows","count","Playlist","findAndCountAll","where","success","error","fail","createPlaylist","body","user","User","findById","playlist","findOrCreate","defaults","deletePlaylist","transaction","sequelize","destroy","PlaylistSong","playlistId","commit","rollback","message","getSongFromPlaylist","removeSongFromPlaylist","songId","findOne","attributes","row","addSongToPlaylist","status","song","Promise","all","Song","isNewRecord"],"mappings":"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","file":"playlist.api.js","sourcesContent":["import Playlist from '../../models/playlist';\nimport User from '../../models/user';\nimport Song from '../../models/song';\nimport PlaylistSong from '../../models/playlist-song';\nimport { Op, sequelize } from '../../common/sequelize-connection';\n\nexport const getPlaylist = async (req, res) => {\n  try {\n    const { id } = req.params;\n    const { limit, offset, name } = req.query;\n    const fliterName = name ? { name: { [Op.like]: `%${name}%` } } : {};\n    const conditions = { userId: id, ...fliterName };\n    const { rows, count } = await Playlist.findAndCountAll({ where: conditions, offset, limit });\n    res.success(rows, { count, limit, offset });\n  } catch (error) {\n    res.fail(error);\n  }\n};\n\nexport const createPlaylist = async (req, res) => {\n  try {\n    const { name, userId } = req.body;\n    //we must know who created it\n    const user = await User.findById(userId);\n    const [playlist] = !user\n      ? res.fail('User Id is not found.')\n      : await Playlist.findOrCreate({ where: { name, userId }, defaults: req.body });\n    res.success(playlist);\n  } catch (error) {\n    res.fail(error);\n  }\n};\n\nexport const deletePlaylist = async (req, res) => {\n  const transaction = await sequelize.transaction();\n  try {\n    const { id } = req.params;\n    await Playlist.destroy({ where: { id }, transaction});\n    await PlaylistSong.destroy({ where: { playlistId: id }, transaction});\n    transaction.commit();\n    res.success('Successfully deleted.');\n  } catch (error) {\n    transaction.rollback();\n    res.fail(error.message);\n  }\n};\n\nexport const getSongFromPlaylist = async (req, res) => {\n  try {\n    // const { id } = req.params;\n    const { rows, count } = await PlaylistSong.findAndCountAll();\n    res.success(rows, { count });\n  } catch (error) {\n    res.fail(error);\n  }\n};\n\nexport const removeSongFromPlaylist = async (req, res) => {\n  try {\n    const { id, songId } = req.params;\n    //check playlist Id is existing\n    //count >findOne\n    const playlist = await Playlist.findOne({ attributes: ['id'], where: { id } });\n    //not => invalid playlist\n    if (!playlist) res.fail('Playlist Id is not valid.');\n    //success => check song id in playlistsong\n    const row = await PlaylistSong.destroy({ where: { playlistId: id, songId: songId } });\n    //if no check songId again\n    if (!row) return res.fail('Song Id is invalid.');\n    res.success('Successfully deletd.');\n  } catch (error) {\n    res.fail(error);\n  }\n};\n\nexport const addSongToPlaylist = async (req, res) => {\n  try {\n    const { status } = req.query;\n    const { id, songId } = req.params;\n    //check if song if existing\n    const [song, playlist] = await Promise.all([\n      Song.findOne({ attributes: ['id'], where: { id: songId, status } }),\n      Playlist.findOne({ attributes: ['id'], where: { id } })\n    ]);\n    //if not => return songId is not found\n    if ( !song ) res.fail('Song is invalid.');\n    if ( !playlist ) res.fail('Playlist is invalid.');\n    //existing => add to table playlistsong\n    const [{ isNewRecord }] = await PlaylistSong.findOrCreate({\n      where: { playlistId: id, songId },\n      defaults: { playlistId: id, songId }\n    });\n    //result._options.isNewRecord =\n    !isNewRecord\n      ? res.success('Song has already added to playlist.')\n      : res.success('Successfully added song to playlist.');\n  } catch (error) {\n    res.fail(error.name);\n  }\n};\n"]}