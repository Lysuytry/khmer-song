{"version":3,"sources":["../../src/models/song.js"],"names":["Song","sequelize","define","id","type","Sequelize","INTEGER","UNSIGNED","autoIncrement","primaryKey","name","STRING","allowNull","duration","size","defaultValue","albumId","references","model","key","onDelete","onUpdate","categoryId","status","ENUM","createdBy","updatedBy","timestamps","insertSong","data","transaction","artistIds","conditions","console","log","song","findOrCreate","where","defaults","artistSongs","map","artistId","songId","ArtistSong","bulkCreate","commit","error","rollback","updateSong","body","fliterArtistSong","destroy","Promise","all","update","rawQuery","stringQuery","query","Error"],"mappings":"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","file":"song.js","sourcesContent":["import { sequelize, Sequelize} from '../common/sequelize-connection';\n// import Album from './album';\n// import Category from './category';\nimport ArtistSong from './artist-song';\n//import Playlist from './playlist';\n\nconst Song = sequelize.define(\n  'songs',\n  {\n    id: { type: Sequelize.INTEGER.UNSIGNED, autoIncrement: true, primaryKey: true },\n    name: { type: Sequelize.STRING, allowNull: false },\n    duration: { type: Sequelize.STRING(10) },\n    size: { type: Sequelize.INTEGER(11), defaultValue: 0 },\n    albumId: {\n      type: Sequelize.INTEGER.UNSIGNED,\n      references: {\n        model: 'albums',\n        key: 'id'\n      },\n      onDelete: 'SET NULL',\n      onUpdate: 'CASCADE'\n    },\n    categoryId: {\n      type: Sequelize.INTEGER.UNSIGNED,\n      references: {\n        model: 'categories',\n        key: 'id'\n      },\n      onDelete: 'SET NULL',\n      onUpdate: 'CASCADE'\n    },\n    status: { type: Sequelize.ENUM('active', 'inactive', 'deleted'), defaultValue: 'active' },\n    createdBy: { type: Sequelize.INTEGER.UNSIGNED, allowNull: false },\n    updatedBy: { type: Sequelize.INTEGER.UNSIGNED, allowNull: false }\n  },\n  { timestamps: true }\n);\n\nexport const insertSong = async data => {\n  const transaction = await sequelize.transaction();\n  try {\n    const { artistIds, duration, size, name } = data;\n    const conditions = { name, duration, size };\n    console.log(data);\n    //create song with that transaction\n    const [song] = await Song.findOrCreate({ where: conditions, defaults: data, transaction });\n    //map into one object => (songId, artistId)\n    const artistSongs = artistIds.map(artistId => ({\n      songId: song.id,\n      artistId: artistId\n    }));\n    //insert many into ArtistSong\n    await ArtistSong.bulkCreate(artistSongs, { transaction });\n    //we need to commit data\n    transaction.commit();\n    //End transaction\n    ////////////////////\n    return song;\n  } catch (error) {\n    transaction.rollback();\n    throw error;\n  }\n};\n\nexport const updateSong = async body => {\n  const transaction = await sequelize.transaction();\n  try {\n    const { data, id, artistIds } = body;\n    let artistSongs;\n    let fliterArtistSong = {};\n    //check if they provide artistIds to update or not\n    if (artistIds) {\n      artistSongs = artistIds.map(artistId => ({\n        songId: id,\n        artistId: artistId\n      }));\n      fliterArtistSong = ArtistSong.destroy({ where: { songId: id }, transaction });\n    }\n    //if have update => 2 process otherwise only once process\n    const [song] = await Promise.all([\n      Song.update(data, { where: { id, status: 'active' }, transaction }),\n      fliterArtistSong\n    ]);\n    //check again\n    if (artistIds) await ArtistSong.bulkCreate(artistSongs, { transaction });\n    transaction.commit();\n    return song;\n  } catch (error) {\n    transaction.rollback();\n    throw error;\n  }\n};\n\nexport const rawQuery = async id => {\n  try {\n    const stringQuery = `SELECT *\n    FROM songs as S INNER JOIN artistSongs as AST ON S.id=AST.songId\n    WHERE S.id=${id}`;\n    // const stringQuery = `SELECT *\n    // FROM album as S LEFT JOIN productions as AST ON S.productionId=AST.Id\n    // WHERE S.id=${id}`;\n    const song = await sequelize.query(stringQuery);\n    return song;\n  } catch (error) {\n    throw new Error('Error');\n  }\n};\n\nexport default Song;\n"]}